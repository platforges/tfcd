name: Deploy Terraform
on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      aws_account_id:
        type: string
        required: true
      hash:
        required: true
        type: string
      ref:
        type: string
        default: ''
      runs-on:
        type: string
        default: ubuntu-latest
      skip:
        type: boolean
        default: false
    outputs:
      result:
        description: Whether terraform apply step was successfull or not
        value: ${{ jobs.deploy.outputs.result }}
permissions:
  id-token: write # configure-aws-credentials
jobs:
  deploy:
    runs-on: ${{ inputs.runs-on }}
    concurrency: deploy-${{ inputs.environment }}
    environment: ${{ inputs.environment }}
    outputs:
      result: ${{ steps.apply.outputs.result }}
    steps:
    - id: apply
      run: |
        echo "Running .github/workflows/deploy.yml ðŸš€"
        echo "environment: ${{ inputs.environment }}"
        echo "aws_account_id: ${{ inputs.aws_account_id }}"
        echo "ref: ${{ inputs.ref }}"
        echo "hash: ${{ inputs.hash }}"
        if [ "${{ inputs.environment }}" = "stg" ]; then
          echo "result=fail" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "result=success" >> $GITHUB_OUTPUT
        fi
